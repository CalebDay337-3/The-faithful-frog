<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Leap & The Storm Castle</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; touch-action: none; user-select: none; }
        body { margin: 0; background: #000; display: flex; justify-content: center; align-items: center; height: 100vh; font-family: 'Press Start 2P', cursive; overflow: hidden; }
        
        #game-wrapper { position: relative; width: 100%; height: 100%; max-width: 500px; aspect-ratio: 9/16; background: #000; border: 2px solid #333; }
        canvas { display: block; width: 100%; height: 100%; }

        .overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.8); display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 20px; z-index: 100; }
        .hidden { display: none !important; }
        
        h1 { font-size: 22px; color: #00ff88; text-shadow: 3px 3px #004422; margin-bottom: 10px; }
        p { font-size: 10px; line-height: 1.6; color: #aaa; margin-bottom: 20px; }
        
        .btn { background: #00ff88; border: none; padding: 15px 25px; font-family: 'Press Start 2P'; font-size: 12px; cursor: pointer; border-radius: 4px; box-shadow: 0 5px #008844; }
        .btn:active { transform: translateY(3px); box-shadow: 0 2px #008844; }

        #hud { position: absolute; top: 40px; left: 0; width: 100%; display: flex; justify-content: space-around; font-size: 10px; pointer-events: none; color: #fff; z-index: 50; }
    </style>
</head>
<body>

<div id="game-wrapper">
    <div id="hud" class="hidden">
        <span id="height-txt">0M</span>
        <span id="best-txt">BEST: 0M</span>
    </div>

    <canvas id="c"></canvas>

    <div id="start-screen" class="overlay">
        <h1>STORM CASTLE</h1>
        <p>THE TOAD KING STOLE THE TROPHY.<br>RECLAIM THE EMERALD DRAGONFLY!</p>
        <button class="btn" onclick="init(true)">START QUEST</button>
        <p style="margin-top:20px; font-size:8px;">[ SOUND WILL PLAY ]</p>
    </div>

    <div id="over-screen" class="overlay hidden">
        <h1 style="color:#ff4444">FELL TO MUD</h1>
        <p id="final-stats"></p>
        <button class="btn" onclick="init(false)">TRY AGAIN</button>
    </div>

    <div id="win-screen" class="overlay hidden">
        <h1>RECLAIMED!</h1>
        <p>THE MARSH IS AT PEACE.</p>
        <button class="btn" onclick="init(false)">PLAY AGAIN</button>
    </div>
</div>

<script>
/** @type {HTMLCanvasElement} */
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');
const hud = document.getElementById('hud');

// Game constants
const W = 400, H = 700;
canvas.width = W; canvas.height = H;
let state = 'START', score = 0, best = 0, cameraY = 0;
let platforms = [], particles = [], stars = [];

// Audio System (Web Audio API Synth)
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function playNote(freq, dur, type = 'square', vol = 0.1) {
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = type; osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
    gain.gain.setValueAtTime(vol, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + dur);
    osc.connect(gain); gain.connect(audioCtx.destination);
    osc.start(); osc.stop(audioCtx.currentTime + dur);
}

const melody = [261, 329, 392, 523, 440, 349, 392, 329];
let noteIdx = 0;
function playMusic() {
    if (state !== 'PLAYING') return;
    playNote(melody[noteIdx], 0.4, 'triangle', 0.05);
    noteIdx = (noteIdx + 1) % melody.length;
    setTimeout(playMusic, 500);
}

// Input
let keys = { L: false, R: false };
window.addEventListener('touchstart', e => {
    const x = e.touches[0].clientX;
    if (x < window.innerWidth/2) keys.L = true; else keys.R = true;
});
window.addEventListener('touchend', () => { keys.L = keys.R = false; });

class Player {
    constructor() {
        this.x = W/2; this.y = H - 150; this.vx = 0; this.vy = 0;
        this.w = 30; this.h = 30; this.dir = 1;
    }
    update() {
        if (keys.L) this.vx = -6, this.dir = -1;
        else if (keys.R) this.vx = 6, this.dir = 1;
        else this.vx *= 0.8;

        this.vy += 0.45; // Gravity
        this.x += this.vx; this.y += this.vy;

        if (this.x < 0) this.x = W; if (this.x > W) this.x = 0;
        
        // Death
        if (this.y - cameraY > H) die();
    }
    draw() {
        ctx.save();
        ctx.translate(this.x, this.y - cameraY);
        // Squash effect based on velocity
        let s = Math.min(Math.abs(this.vy)*0.05, 0.3);
        ctx.scale(this.dir * (1+s), 1-s);
        
        ctx.fillStyle = '#44ff44';
        ctx.beginPath(); ctx.roundRect(-15, -15, 30, 30, 8); ctx.fill();
        // Eyes
        ctx.fillStyle = 'white'; ctx.fillRect(2, -10, 8, 8); ctx.fillRect(12, -10, 8, 8);
        ctx.fillStyle = 'black'; ctx.fillRect(6, -6, 4, 4); ctx.fillRect(16, -6, 4, 4);
        ctx.restore();
    }
}

class Platform {
    constructor(y, type = 'norm') {
        this.x = Math.random() * (W - 80); this.y = y;
        this.w = 80; this.h = 15; this.type = type;
        this.off = Math.random() * 100;
    }
    draw() {
        letd drawX = this.x;
        if (this.type === 'move') drawX += Math.sin(Date.now()/500 + this.off) * 50;
        
        ctx.fillStyle = this.type === 'crumb' ? '#aaa' : '#fff';
        if (this.type === 'castle') ctx.fillStyle = '#ffcc00';
        
        ctx.beginPath();
        ctx.roundRect(drawX, this.y - cameraY, this.w, this.h, 10);
        ctx.fill();

        if (this.type === 'castle') {
            // Trophy glow
            ctx.shadowBlur = 15; ctx.shadowColor = "gold";
            ctx.fillStyle = "#00ff88"; ctx.fillRect(drawX+30, this.y - cameraY - 40, 20, 20);
            ctx.shadowBlur = 0;
        }
    }
}

let leap = new Player();

function init(firstTime) {
    if (firstTime) audioCtx.resume();
    state = 'PLAYING'; score = 0; cameraY = 0;
    platforms = [new Platform(H-100, 'norm')];
    for (let i = 1; i < 15; i++) spawnPlatform(H - i * 120);
    stars = Array(50).fill(0).map(() => ({x: Math.random()*W, y: Math.random()*H, s: Math.random()*2}));
    
    document.querySelectorAll('.overlay').forEach(el => el.classList.add('hidden'));
    hud.classList.remove('hidden');
    playMusic();
}

function spawnPlatform(y) {
    let type = 'norm';
    if (y < -1000) type = Math.random() < 0.3 ? 'move' : 'norm';
    if (y < -3000) type = Math.random() < 0.2 ? 'crumb' : type;
    if (y < -5000) type = 'castle';
    platforms.push(new Platform(y, type));
}

function die() {
    state = 'OVER';
    playNote(150, 0.5, 'sawtooth');
    document.getElementById('over-screen').classList.remove('hidden');
    document.getElementById('final-stats').innerText = `CLIMBED: ${Math.floor(score/10)}M`;
}

function win() {
    state = 'WIN';
    playNote(523, 0.1); playNote(659, 0.1); playNote(783, 0.3);
    document.getElementById('win-screen').classList.remove('hidden');
}

function loop() {
    ctx.clearRect(0,0,W,H);
    
    // Background Gradient (Day to Twilight)
    let p = Math.min(score / 50000, 1);
    let topCol = `rgb(${135-p*100}, ${206-p*200}, ${235-p*150})`;
    let botCol = `rgb(${50-p*50}, ${0}, ${100-p*50})`;
    let grad = ctx.createLinearGradient(0,0,0,H);
    grad.addColorStop(0, topCol); grad.addColorStop(1, botCol);
    ctx.fillStyle = grad; ctx.fillRect(0,0,W,H);

    // Parallax Stars
    ctx.fillStyle = "white";
    stars.forEach(s => {
        s.y += 0.2; if (s.y > H) s.y = 0;
        ctx.fillRect(s.x, s.y, s.s, s.s);
    });

    if (state === 'PLAYING') {
        leap.update();
        
        // Camera follow
        if (leap.y < cameraY + H/2) {
            let diff = (cameraY + H/2) - leap.y;
            cameraY -= diff;
            score += diff;
        }

        // Collision
        if (leap.vy > 0) {
            platforms.forEach(p => {
                let px = p.type === 'move' ? p.x + Math.sin(Date.now()/500 + p.off) * 50 : p.x;
                if (leap.x > px - 20 && leap.x < px + p.w + 20 && 
                    leap.y + 15 > p.y && leap.y + 15 < p.y + p.h + 10) {
                    leap.vy = -14;
                    playNote(400 + Math.random()*100, 0.1, 'sine', 0.05);
                    if (p.type === 'crumb') p.y = 9999;
                    if (p.type === 'castle') win();
                }
            });
        }

        // Infinite generation
        if (platforms[platforms.length-1].y > cameraY - 100 && score < 50000) {
            spawnPlatform(platforms[platforms.length-1].y - 120);
        }
        
        best = Math.max(score, best);
        document.getElementById('height-txt').innerText = Math.floor(score/10) + "M";
        document.getElementById('best-txt').innerText = "BEST:" + Math.floor(best/10) + "M";
    }

    platforms.forEach(p => p.draw());
    leap.draw();
    
    requestAnimationFrame(loop);
}

loop();
</script>
</body>
</html>
